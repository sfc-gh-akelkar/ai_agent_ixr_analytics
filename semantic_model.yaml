# ============================================================================
# PATIENTPOINT COMMAND CENTER - SEMANTIC MODEL
# ============================================================================
# This YAML file configures the Cortex Analyst for natural language queries
# against the device fleet health data. This enables the "AI Operations Agent"
# to answer questions about device health, failures, and regional status.
# ============================================================================

name: patientpoint_device_health_model
description: |
  Semantic model for PatientPoint medical device fleet analytics.
  Enables natural language queries about device health, failure predictions,
  regional status, and maintenance insights.

# ============================================================================
# DATABASE CONNECTION
# ============================================================================
connection:
  database: PATIENTPOINT_OPS
  schema: DEVICE_ANALYTICS
  warehouse: COMPUTE_WH

# ============================================================================
# BASE TABLES
# ============================================================================
tables:
  - name: FLEET_HEALTH_SCORED
    description: |
      Real-time health scores and failure predictions for all devices in the fleet.
      Updated hourly by ML inference pipeline. Each row represents one device.
    base_table:
      database: PATIENTPOINT_OPS
      schema: DEVICE_ANALYTICS
      table: FLEET_HEALTH_SCORED
    
    # Define the table structure
    columns:
      - name: device_id
        description: Unique identifier for each PatientPoint device
        data_type: VARCHAR
        synonyms: ["device", "unit", "machine", "equipment id"]
      
      - name: region
        description: US State where the device is deployed
        data_type: VARCHAR
        synonyms: ["state", "location", "geography", "area"]
      
      - name: hospital_name
        description: Name of the hospital or medical facility
        data_type: VARCHAR
        synonyms: ["hospital", "facility", "medical center", "clinic", "site"]
      
      - name: last_ping
        description: Last time device checked in with monitoring system
        data_type: TIMESTAMP_LTZ
        synonyms: ["last contact", "last seen", "last communication"]
      
      - name: cpu_load
        description: Current CPU utilization percentage (0-100)
        data_type: FLOAT
        synonyms: ["processor usage", "cpu usage", "cpu percent"]
      
      - name: voltage
        description: Power supply voltage reading in volts
        data_type: FLOAT
        synonyms: ["power", "electrical voltage"]
      
      - name: memory_usage
        description: Current memory utilization percentage (0-100)
        data_type: FLOAT
        synonyms: ["ram usage", "memory percent", "ram"]
      
      - name: temperature
        description: Device operating temperature in Celsius
        data_type: FLOAT
        synonyms: ["temp", "heat", "thermal reading"]
      
      - name: uptime_hours
        description: Total operational hours since last service
        data_type: INTEGER
        synonyms: ["runtime", "hours", "operational time"]
      
      - name: failure_probability
        description: |
          ML model predicted probability of failure in next 24 hours (0.0 to 1.0).
          Values above 0.85 are considered critical.
        data_type: FLOAT
        synonyms: ["failure score", "risk score", "probability", "failure risk", "failure chance"]
      
      - name: predicted_failure_type
        description: Most likely type of failure if device fails
        data_type: VARCHAR
        synonyms: ["failure mode", "failure category", "issue type", "problem type"]
      
      - name: latitude
        description: Geographic latitude coordinate
        data_type: FLOAT
      
      - name: longitude
        description: Geographic longitude coordinate
        data_type: FLOAT
      
      - name: created_at
        description: Timestamp when this health record was created
        data_type: TIMESTAMP_LTZ

  - name: MAINTENANCE_LOGS
    description: |
      Historical maintenance and repair records for cost analysis and ROI calculations.
      Contains both preventive and reactive maintenance events.
    base_table:
      database: PATIENTPOINT_OPS
      schema: DEVICE_ANALYTICS
      table: MAINTENANCE_LOGS
    
    columns:
      - name: log_id
        description: Unique maintenance log entry identifier
        data_type: INTEGER
      
      - name: device_id
        description: Device that received maintenance
        data_type: VARCHAR
        synonyms: ["device", "unit"]
      
      - name: maintenance_date
        description: Date and time maintenance was performed
        data_type: TIMESTAMP_LTZ
        synonyms: ["repair date", "service date"]
      
      - name: failure_type
        description: Type of failure that was addressed
        data_type: VARCHAR
        synonyms: ["issue type", "problem type", "failure mode"]
      
      - name: downtime_hours
        description: Number of hours device was offline for repair
        data_type: FLOAT
        synonyms: ["downtime", "offline time", "outage duration"]
      
      - name: repair_cost
        description: Total cost of repair including parts and labor
        data_type: FLOAT
        synonyms: ["cost", "expense", "repair expense", "maintenance cost"]
      
      - name: parts_replaced
        description: List of components that were replaced
        data_type: VARCHAR
        synonyms: ["components", "parts"]
      
      - name: technician_notes
        description: Service notes from technician
        data_type: VARCHAR
        synonyms: ["notes", "comments"]
      
      - name: preventive
        description: Whether this was preventive (true) or reactive (false) maintenance
        data_type: BOOLEAN
        synonyms: ["proactive", "scheduled"]

# ============================================================================
# RELATIONSHIPS (For joined queries)
# ============================================================================
relationships:
  - name: fleet_to_maintenance
    description: Links devices to their maintenance history
    type: one_to_many
    from_table: FLEET_HEALTH_SCORED
    from_column: device_id
    to_table: MAINTENANCE_LOGS
    to_column: device_id

# ============================================================================
# METRICS (Pre-calculated business KPIs)
# ============================================================================
metrics:
  - name: total_devices
    description: Total number of devices in the fleet
    type: count
    definition:
      sql: COUNT(*)
    from_table: FLEET_HEALTH_SCORED
    synonyms: ["device count", "number of devices", "fleet size"]
  
  - name: count_critical_devices
    description: |
      Number of devices with failure probability greater than 0.8.
      These devices require immediate attention.
    type: count
    definition:
      sql: COUNT_IF(failure_probability > 0.80)
    from_table: FLEET_HEALTH_SCORED
    synonyms: 
      - "critical devices"
      - "high risk devices"
      - "devices at risk"
      - "failing devices"
      - "urgent devices"
  
  - name: count_at_risk_devices
    description: |
      Number of devices with failure probability greater than 0.7.
      This includes both high risk and critical devices.
    type: count
    definition:
      sql: COUNT_IF(failure_probability > 0.70)
    from_table: FLEET_HEALTH_SCORED
    synonyms: 
      - "at risk"
      - "risky devices"
      - "concerning devices"
  
  - name: total_revenue_at_risk
    description: |
      Estimated revenue at risk in USD based on devices with failure probability > 0.8.
      Calculated as $50/hour * 24 hours * number of critical devices.
      This represents potential revenue loss if these devices fail.
    type: sum
    definition:
      sql: SUM(CASE WHEN failure_probability > 0.80 THEN 50 * 24 ELSE 0 END)
    from_table: FLEET_HEALTH_SCORED
    synonyms:
      - "revenue at risk"
      - "revenue risk"
      - "potential loss"
      - "financial risk"
      - "money at risk"
  
  - name: average_failure_probability
    description: Average failure probability across all devices
    type: average
    definition:
      sql: AVG(failure_probability)
    from_table: FLEET_HEALTH_SCORED
    synonyms: ["avg failure probability", "mean risk score"]
  
  - name: total_maintenance_cost
    description: Total historical maintenance costs in USD
    type: sum
    definition:
      sql: SUM(repair_cost)
    from_table: MAINTENANCE_LOGS
    synonyms: ["total cost", "maintenance spend", "repair expenses"]
  
  - name: average_downtime_hours
    description: Average device downtime per maintenance event
    type: average
    definition:
      sql: AVG(downtime_hours)
    from_table: MAINTENANCE_LOGS
    synonyms: ["avg downtime", "mean downtime", "typical downtime"]
  
  - name: preventive_maintenance_rate
    description: Percentage of maintenance that was preventive vs reactive
    type: percentage
    definition:
      sql: (SUM(CASE WHEN preventive THEN 1 ELSE 0 END)::FLOAT / COUNT(*)) * 100
    from_table: MAINTENANCE_LOGS
    synonyms: ["preventive rate", "proactive maintenance percentage"]

# ============================================================================
# DIMENSIONS (Groupable attributes for analysis)
# ============================================================================
dimensions:
  - name: region
    description: US State where devices are located
    type: categorical
    from_table: FLEET_HEALTH_SCORED
    column: region
    synonyms: ["state", "location", "geography"]
  
  - name: hospital_name
    description: Hospital or medical facility name
    type: categorical
    from_table: FLEET_HEALTH_SCORED
    column: hospital_name
    synonyms: ["hospital", "facility", "site"]
  
  - name: predicted_failure_type
    description: |
      Type of predicted failure. Common values include:
      - Overheating
      - Memory Leak
      - CPU Exhaustion
      - Power Supply Failure
      - Component Degradation
      - System Instability
    type: categorical
    from_table: FLEET_HEALTH_SCORED
    column: predicted_failure_type
    synonyms: ["failure type", "issue type", "problem type", "failure mode"]
  
  - name: risk_category
    description: |
      Risk categorization based on failure probability:
      - Critical: > 0.85
      - High: 0.70 - 0.85
      - Medium: 0.50 - 0.70
      - Low: < 0.50
    type: categorical
    definition:
      sql: |
        CASE 
          WHEN failure_probability > 0.85 THEN 'Critical'
          WHEN failure_probability > 0.70 THEN 'High'
          WHEN failure_probability > 0.50 THEN 'Medium'
          ELSE 'Low'
        END
    from_table: FLEET_HEALTH_SCORED
    synonyms: ["risk level", "severity", "priority"]
  
  - name: device_status
    description: |
      Operational status based on last ping time:
      - Online: Checked in within last hour
      - Offline: No contact for over 1 hour
    type: categorical
    definition:
      sql: |
        CASE 
          WHEN DATEDIFF(MINUTE, last_ping, CURRENT_TIMESTAMP()) <= 60 THEN 'Online'
          ELSE 'Offline'
        END
    from_table: FLEET_HEALTH_SCORED
    synonyms: ["status", "connection status", "online status"]

# ============================================================================
# FILTERS (Pre-defined filter conditions)
# ============================================================================
filters:
  - name: critical_only
    description: Show only devices with failure probability greater than 0.85
    definition:
      sql: failure_probability > 0.85
    from_table: FLEET_HEALTH_SCORED
  
  - name: at_risk_threshold
    description: Show devices with failure probability greater than 0.70
    definition:
      sql: failure_probability > 0.70
    from_table: FLEET_HEALTH_SCORED
  
  - name: offline_devices
    description: Show devices that haven't checked in within the last hour
    definition:
      sql: DATEDIFF(MINUTE, last_ping, CURRENT_TIMESTAMP()) > 60
    from_table: FLEET_HEALTH_SCORED
  
  - name: high_temperature
    description: Show devices operating above 75 Celsius
    definition:
      sql: temperature > 75
    from_table: FLEET_HEALTH_SCORED

# ============================================================================
# VERIFIED QUERIES (Example queries with known good outputs)
# ============================================================================
verified_queries:
  - question: "How many critical devices are there?"
    sql: |
      SELECT COUNT(*) AS critical_device_count
      FROM FLEET_HEALTH_SCORED
      WHERE failure_probability > 0.80
    
  - question: "What is the total revenue at risk?"
    sql: |
      SELECT SUM(CASE WHEN failure_probability > 0.80 THEN 50 * 24 ELSE 0 END) AS revenue_at_risk_usd
      FROM FLEET_HEALTH_SCORED
    
  - question: "Show me critical devices in New York"
    sql: |
      SELECT device_id, hospital_name, failure_probability, predicted_failure_type
      FROM FLEET_HEALTH_SCORED
      WHERE region = 'New York' AND failure_probability > 0.80
      ORDER BY failure_probability DESC
    
  - question: "What are the most common failure types for at-risk devices?"
    sql: |
      SELECT predicted_failure_type, COUNT(*) AS device_count
      FROM FLEET_HEALTH_SCORED
      WHERE failure_probability > 0.70
      GROUP BY predicted_failure_type
      ORDER BY device_count DESC
    
  - question: "Show devices with overheating issues"
    sql: |
      SELECT device_id, hospital_name, region, failure_probability, temperature
      FROM FLEET_HEALTH_SCORED
      WHERE predicted_failure_type = 'Overheating'
      ORDER BY failure_probability DESC
    
  - question: "What is the average repair cost by failure type?"
    sql: |
      SELECT failure_type, 
             COUNT(*) AS incident_count,
             ROUND(AVG(repair_cost), 2) AS avg_repair_cost
      FROM MAINTENANCE_LOGS
      GROUP BY failure_type
      ORDER BY avg_repair_cost DESC

# ============================================================================
# NATURAL LANGUAGE MAPPINGS (Teach Analyst common phrasings)
# ============================================================================
synonyms:
  # Risk-related terms
  - term: "at risk"
    maps_to: "failure_probability > 0.70"
    type: filter
  
  - term: "critical"
    maps_to: "failure_probability > 0.85"
    type: filter
  
  - term: "healthy"
    maps_to: "failure_probability < 0.50"
    type: filter
  
  # Location terms
  - term: "NY"
    maps_to: "New York"
    applies_to: region
  
  - term: "CA"
    maps_to: "California"
    applies_to: region
  
  - term: "TX"
    maps_to: "Texas"
    applies_to: region
  
  # Failure type synonyms
  - term: "overheating"
    maps_to: "Overheating"
    applies_to: predicted_failure_type
  
  - term: "memory issue"
    maps_to: "Memory Leak"
    applies_to: predicted_failure_type
  
  - term: "cpu problem"
    maps_to: "CPU Exhaustion"
    applies_to: predicted_failure_type
  
  - term: "power issue"
    maps_to: "Power Supply Failure"
    applies_to: predicted_failure_type

# ============================================================================
# BUSINESS CONTEXT (Help Analyst understand domain)
# ============================================================================
business_context: |
  PatientPoint devices are medical point-of-care information systems deployed
  in hospitals across the United States. Each device:
  
  - Costs approximately $15,000
  - Generates ~$50/hour in advertising and patient education revenue
  - Downtime is extremely costly due to both lost revenue and patient care impact
  - Critical devices (failure_probability > 0.85) should be serviced within 24 hours
  - At-risk devices (failure_probability > 0.70) should be monitored closely
  
  Failure types and typical resolution times:
  - Overheating: 2-4 hours, often due to dust or fan failure
  - Memory Leak: 1-3 hours, usually resolved by firmware update or RAM replacement
  - CPU Exhaustion: 30 min - 2 hours, typically software optimization
  - Power Supply Failure: 2-4 hours, requires PSU replacement (CRITICAL priority)
  - Component Degradation: 4-6 hours, devices with 7000+ operational hours
  - System Instability: Variable, requires diagnosis
  
  Revenue at risk is calculated as: 
  (Number of critical devices) × $50/hour × 24 hours = Potential 24-hour revenue loss

# ============================================================================
# VERSION AND METADATA
# ============================================================================
version: "1.0.0"
last_updated: "2025-12-12"
owner: "Data Engineering Team"
contact: "data-engineering@patientpoint.com"

